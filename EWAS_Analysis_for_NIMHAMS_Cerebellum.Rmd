---
title: "EWAS Analysis for NIMHAMS"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This script will first analyse the frontal cortex and then the cerebellum. We will look at what probes differ between individuals.





## Load the data
The normalised data for Frontal and Cerebellum will be loaded in seperately.

```{r loading data, warning= FALSE, message=FALSE}
library(dplyr)
library(qqman)
library(gplots)


setwd("/mnt/data1/NIMHANS/Down_stream_analysis/") ## change to working directory path
epicManifest<-read.csv("450_Manifest.csv", stringsAsFactors = F, header=T)
load("NIMHAM_CER_Normalised_snpsremoved.rdat") ## Load in the cerebellum.
#as the frontal and cerebellum will have the same name dataset anmes, renaming the pheno and beta will help differeniate the two
pheno_c <- pheno
betas_c <- betas

rm(pheno,betas) #remove the non-labelled betas and pheno files as it maybe confusing later on

## these commands create a folder to save the EWAS output
if(!dir.exists("EWAS")){
  dir.create("EWAS")
}
if(!dir.exists("EWAS/Plots")){
  dir.create("EWAS/Plots")
}

```

## Run the EWAS on cerebellum

We have several co-variants to consider. In this experiment, we will consider the chip location, age and sex as we have already seperated the brain regions.

```{r linear model for frontal, message=FALSE, warning = FALSE}
#set betas here to what beta region you want
betas <- betas_c
pheno <- pheno_c
# #create an empty matrix of the probes with 3 columns.
# res<-matrix(data = NA, nrow = nrow(betas), ncol = 6)
# colnames(res)<-c("Age_Beta", "Age_SE", "Age_P", "Sex_Beta", "Sex_SE", "Sex_P")
# rownames(res)<-rownames(betas)
# pheno$Age <- as.integer(pheno$Age)
# 
# for(i in 1:nrow(betas)){
#     model<-lm(betas[i,] ~ pheno$Age + factor(pheno$Sex)+ factor(pheno$Chip)) 
#     res[i,1]<-coefficients(model)["pheno$Age"]
#     res[i,2]<-summary(model)$coefficients["pheno$Age",2]
#     res[i,3]<-summary(model)$coefficients["pheno$Age",4]
#     res[i,4]<-coefficients(model)["factor(pheno$Sex)M"]
#     res[i,5]<-summary(model)$coefficients["factor(pheno$Sex)M",2]
#     res[i,6]<-summary(model)$coefficients["factor(pheno$Sex)M",4]
# }
# head(res)
# 
# #need to make the beta and SE as percentage
# res[,"Sex_Beta"] <- res[,"Sex_Beta"]*100
# res[,"Sex_SE"] <- res[,"Sex_SE"]*100
# res[,"Age_Beta"] <- res[,"Age_Beta"]*100
# res[,"Age_SE"] <- res[,"Age_SE"]*100
# # head(res) #535566 rows, 6 columns
# write.csv(res, 'res_c_chip.csv')
```

Once the res table is generated. Save as it taken times to usually run it

```{r annotations, message=FALSE, warning = FALSE}
# read the res file
res <- read.csv('res_c_chip.csv', header = T, row.names = 1)
epicManifest<-epicManifest[match(rownames(res), epicManifest$Name),]
res<-cbind(res, epicManifest[,c("CHR", "MAPINFO", "UCSC_RefGene_Name", "UCSC_RefGene_Group", "Relation_to_UCSC_CpG_Island", "Regulatory_Feature_Name", "Regulatory_Feature_Group", "DNase_Hypersensitivity_NAME", "OpenChromatin_NAME", "TFBS_Evidence_Count", "Methyl450_Loci", "SNP_ID", "SNP_DISTANCE", "SNP_MinorAlleleFrequency")])

write.csv(res, "res_c_chip_included_manifest.csv") 

```


##Visualising the results

```{r QQplots, message=FALSE}
pdf('Cer QQplot of sex&Age.pdf')
par(mfrow = c(2,2))
qq(res$Sex_Beta)
qq(res$Age_Beta)
dev.off()


```


```{r manhatten plots, message=FALSE}

res<-res[which(res$CHR != "Y"),] ## to also exclude the X chromosome repeat and edit this line
res<-res[which(res$CHR != "23"),]
res$CHR<-as.character(res$CHR)
#res$CHR[which(res$CHR == "X")]<-23 ## to also recode Y chromosome repeat and edit this line
res$CHR<-as.numeric(res$CHR)
res<-res[which(res$CHR != ""),]
bonfP<-0.05/nrow(res)

pdf('Cer Manhattan plots.pdf', onefile = T)
par(mfrow = c(2,1))
manhattan(res, p = "Age_P", bp = "MAPINFO", chr = "CHR", genomewide = -log10(bonfP), suggestiveline = -log10(5e-5), logp=T, col=c("blue","yellow"), ylim=c(0,8))
manhattan(res, p = "Sex_P", bp = "MAPINFO", chr = "CHR", genomewide = -log10(bonfP), suggestiveline = -log10(5e-5), logp=T, col=c("blue","yellow"), ylim=c(0,8))
dev.off()
```


Scatter plot of significant robes.

```{r scatter plot , warning= F, message=FALSE}
res<-res[order(res$Age_P),]
pdf('Cer scatter plots.pdf', onefile = T)
par(mfrow = c(2,3)) ## will plot 6 figures per page in 2 rows by 3 columns
for(i in 1:6){
  plot(pheno$Age, betas[rownames(res)[i],]*100 , xlab = "Age", ylab = "DNA methylation (%)", pch = 16, main = rownames(res)[i]) ## we multiple by 100 to plot of a % scale rather than proportion
  ## to add line of best fit
  model<-lm(betas[rownames(res)[i],]*100 ~ pheno$Age)
  abline(model, col = "red")  
}

res<-res[order(res$Sex_P),]
par(mfrow = c(2,3)) ## will plot 6 figures per page in 2 rows by 3 columns
for(i in 1:6){
  plot(pheno$Sex, betas[rownames(res)[i],]*100 , xlab = "Sex", ylab = "DNA methylation (%)", pch = 16, main = rownames(res)[i]) 
  model<-lm(betas[rownames(res)[i],]*100 ~ pheno$Sex)
  abline(model, col = "red")  
}
dev.off

```



Heatmap based on the order of most significant probes between sexes

```{r pheatmap sex, message=FALSE} 

res<-res[order(res$Sex_P),]
res_sig <- res[1:500,]
betas_r <- betas[rownames(res_sig),]
sigma<-apply(betas, 1, sd)

cell_rows <- as.data.frame(pheno$Sex, rownames(pheno))
colnames(cell_rows)<- "Sex"
cell_age <- as.data.frame(pheno$Age, rownames(pheno))
colnames(cell_age)<- "Age"
cell_chip <- as.data.frame(pheno$Chip, rownames(pheno))
colnames(cell_chip)<- "Chip"
cell_rows <- cbind(cell_rows, cell_age, cell_chip)


pdf('Cer pheatmaps of Sex.pdf', onefile = T)
pheatmap(betas_r, scale = 'row', 
         annotation_col = cell_rows,
         cluster_rows = F,
         show_rownames = F,
         show_colnames = F,
         main="Top significant probes between sexes")
pheatmap(betas[order(sigma, decreasing = TRUE)[1:500],], scale = 'row', 
         annotation_col = cell_rows,
         cluster_rows = F,
         show_rownames = F,
         show_colnames = F,
         main="Top varying probes")
dev.off()

``` 

```{r pheatmap of ages}
res<-res[order(res$Age_P),]
res_sig <- res[1:500,]
betas_r <- betas[rownames(res_sig),]
sigma<-apply(betas, 1, sd)


cell_rows <- as.data.frame(pheno$Sex, rownames(pheno))
colnames(cell_rows)<- "Sex"
cell_age <- as.data.frame(pheno$Age, rownames(pheno))
colnames(cell_age)<- "Age"
cell_chip <- as.data.frame(pheno$Chip, rownames(pheno))
colnames(cell_chip)<- "Chip"
cell_rows <- cbind(cell_rows, cell_age, cell_chip)

pdf('Cer pheatmaps of Age.pdf', onefile = T)
#par(mfrow = c(2,1))
pheatmap(betas_r, scale = 'row', 
         annotation_col = cell_rows,
         cluster_rows = F,
         show_rownames = F,
         show_colnames = F,
         main="Top significant probes between Ages")
pheatmap(betas[order(sigma, decreasing = TRUE)[1:500],], scale = 'row', 
         annotation_col = cell_rows,
         cluster_rows = F,
         show_rownames = F,
         show_colnames = F,
         main="Top varying probes")
dev.off()

```

